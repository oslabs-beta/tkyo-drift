/*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*::::-%@@#:..-:..+@@@@@@@@@%#++==+*%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%##########********#######%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+:#@@@@@@=.-=+#++:..:=+*##*=..*%%@@@@%#=:@@@@@@@@@@%**@@@@@@@@@@@%#+=-::..::-==+**######%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%#:.-@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@@@@@@@@@@+%@@@@@@@@@@:.-:=#@@@@@@@@@@@@@%%=%@@@@@@%*.:-*%%%%*-*+=-:.:-=+*#%%######%%%%###***+++=====--------======+++++++****####%%%%@@%%#=--:+@@@@@@@@@@@@@@@@@@@@@@@=-@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+*@@@@@@@@@@@@@@@@@@@@@%%%@@@@@@%-%%%+..=#%%#####*+=--=+**##%%%%%#*++=--::.........................................:%@%.....:...:::-=+*#%@@@@@@@@@**:@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%%@@@@@%#%#:-%####%%#**+=-:.                                                                 -%#. :.....::::::::::::::::::-*.@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@.#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%%@@%@@@%%=:%%*..                                                                              .%@:..:.....::::::::::::::::=-:@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@=-@@*@@@@@@@@@@@@@@@@@@@@@%*==-:.-#@@@@@@@@@@@@@@@@@@@@@%:#%+..            .************=:*****:.=****+-+****===*####=--+#%@@@@%#*::::...........%%:..-.   :@@@@@@@@@@@@@@@==-@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@=--@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%+.*@@@@@@@@@@@@@@@@@@=-%%..       ......:@@@@@@@@@@@@%.%@@@@=+@@@@%:.*@@@@#:.#@@@@+.%@@@@@@@@@@@@:....     --.=.#@-..::    +@@@@@@@@@@@@@+=+@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@#-%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@#:@@@#@@@@@@@@@@@@%.*#+.:=++:.     .......:%@@@@*:...%@@@@%@@@@@-..-@@@@@=.*@@@@%.@@@@@=..@@@@@:           -=--:%%...--    .%@@@@@@@@@@@=-%@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@%.#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=@@@@-*@@@@@@@@@*-%%.:-:-=*@@%::... .+.  %@@@@#.#-.#@@@@@@@@@@@@*.-@@@@@@@@@@@=.*@@@@#..%@@@@**:          .=+=-.%@:..--.    =@@@@%%%%%@*=@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@-+@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%@@@@@@#-:-=+*+-=##:--:=-..:==%@%=-.....#@@@@%.   :@@@@@+=#@@@@%. .-@@@@@@@%:..=@@@@@. =@@@@%. ..:.         =+=:-@%...:=..+%%#****####%-%@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@%.%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.+#+:-+=+:.   . =---%%+-.:@@@@@.   .@@@@@#:+@@@@@:    #@@@@%.....@@@@@@@@@@@@#.               :+++.=@%=:.=:=:+@@%########%.@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@*:%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@=-:----....:#@:##=::+++.       ...==.-@*@@@@@-... *@@@@-..%@@@@%. ..*@@@@#. ....=@@@@@@@@@+.                  -++-.*@*==..*:@@%%######%*+=@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@*:%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@+*####*=:=*=-%*.*#=--+++.          ....+:.+@=-.  ..             ...##-.......... ....       ...........         .=-=.-@@*-+-=............=@@@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@%.*@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@.%#####%@*::.-:*#-.=+==.                 .=..##:...          ........:##:........... .-=+++====------------:.   ......*@@=-==-.:+*#*:%%%#-:#@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@=:#@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%-:.:::...:=#:##=:-+=-.                   .....*@###########%@@#***%@###########@@#===+@%###########@@+*@%###########%@@@##############@%***-:@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@:=:.#@@@@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@%#+:...+**#+ . ....:-==+++=---::::-==++**#%@+             :@@@@@-            -@@@@@#           +@@@@+           .@@%.             *@****+:.=@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@#.=++++.-#%@@@@@@@@@@@@@@@%-@@@@@@@@@@@@@@@*:%-::==***#%@@@@@@@@@@@@@@@@@@@@@@@@@@@@*    +@@@%.    *@@@@#.   %@@@.   .#@@@@@@@@:    #@@@@@@@%.   +@@@@@@@@@@@@@@=    :@@@@@@###%%*.:.:@@@@@@@@@@@@@@@@@@@        
@@@@%:. ..-+**-....=%%%@@@@@@@@%#:*@@@@@@@@@@@@@+.+-.++==-*##@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%.   +@@@@@.   .@@@@@    -@@@#.  :@@@@@@@@@*    =@@@@@@@@.   :@@@@@@#*@@@#.%@:    @@@*++-#@@@@*.:..*@@@@@@@@@@@@@@@@@@        
@@@+-#@@@@@@@@@@@@+.=:..-+++=:.=.#@@@@@@@@@@@@@@#..#@%@-=*##%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@    -@@@@@=   .@@@@@:            -#@@@@@@@%.   -@@@@@@@@-         #@@@@@@=%@-   .#%-#%%*+@@@@@+.:  -@@@@@@@@@@@@@@@@@@        
%-@@@@@@@@@@@@@@@@@+..+@=.*@@@@@.*%%@@@@%%@@%..*-=*@@#@:**%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@-   .@@@@@+    #@@@@-    -@@@-    =@@@@@@@@.   :@@@@@@@@=    +@@@@@@@@@@@%*@+    +@:.     .=@@@=.:  :@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@@*%@@@@@+*@@@@@#=..=*@@@.:**##*:%@@##-+*%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@*    -***+-    #@@@@+    %@@@@@.   =@@@@*++:    :++%@%%@*    *@#**=#%@@@@@@@%.   =@+..      ..:*-.:  :%@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@%*@@@@@@@*@@@@@@@@:-%%%:.#####+:%@@#=*++#%%%%%*%%@@@@@@@@@@@@@@@@@@@@@*            .-@@@@@%.   #@@@@@.    @@@@.          -@%#@@.   *@#**-%%*-...-@%    :@@:    ..  ....:.:  .%@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@%@@@@@@@@@@@@@@@@@@@%.   -**###-:@@@%**=*==#%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@%%%%%@@@@@@@%%%@@@@@@@#=@@@@@@@@@@@@@@*:+@@@@@@@#++=:=++++++*@@@@@@@@*.    .=..  .:..:. .#@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@: .=-.=+%@%%-...-*#-:+++++++++++++====---:::...........................::::--------:::.::.-++++++++++++=.++++++++++++-:+++++++=.=#@@@@*+.    :.-.: ....:=*=#@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%.:=-:..=+%@%%-.-+++++:-++++++++++=:=++++++++++++-.:-:Authored By:                      ::.=+++++++++++++:-++++++++++++:-+++++-.=:=%@@@@=-     :.:.: .::.-**=*@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@=@@@@@@@@@@@@@@@@+..%@@.-=:-   =+#@@%=.-=++++=.=++++++++++:=+++++++++++++=..-:Tico, Milti, Anthony, Wing, Monique==++++++=======.-=====--:::::--=*##*-..:=@@@@%=:     .::.:  --.-**-*@@@@@@@@@@@@@@@@@        
@@@@@@@@@@*-@@@@@@@@@@@@@@@@@@@-=-:=....  =+*@@@+ .:-++++:.==++++++++=.==+++++++++++==...................::--==++*****+++======-----:::::---==+++*****######%%%#%%%%*@@@@%=.     .=:.: ..:::**-#@@@@@@@@@@@@@@@@@        
@@@@@@@@@@+:@@@@@@@@@@@@@@@@@@@@.:=.......-##@@@*...-**+++**##%%%%%%%%%%%%##**+++=======+++***###%%%%%%@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%#####***###%%%%@@@@@@@%%%%%%%%#@@@@%:....  .=... :.:-.**-#@@@@@@@@@@@@@@@@@        
@@@@@@@@@@#.+@@@@@@@@@@@@@@@@@@@.=-.-==....##@@@%**%%%%%%####*******####%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@%#%%%%%%%@@@@*..:..  .-... :..- =*=%@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@#.:%@@@@@@@@@@@@@@@@%.=.=+==.:..=%@@@@%#@@@@@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%#####***********+++============+**##%%%%%%%##%@@@@@@@@@@@@@@@@@@@%%##**+*@%%@#*++=.-::..  .:... :..-.:*-###%%%%@@@@@@@@@@@        
@@@@@@@@@@@@@*...-#@@@@@@@@@@@@#:=:+==-.:...=%@@@@%%@@@@@@@@@@@@@@@@@@@@@%%@@@@%%%%%##**+===-----:::::........... ......:::--.    .  .%@#--:::---=--::::.-=++++:%%@@@@@#:.=.:..  ..... ..::.....................:        
@@@@@@@@@@@@@@@@@@@%.+@@@@@@@@@*-=-+=-=:..    -+#%%%++********########***%@-..  ....:===:....::::........:::::::::::::::..:===-   : .=.%@%########*+..    .=++=#@@@@@@@%.-=..    .. :.  -:....:::----==+*%@@@@@@@        
@@@@@@#@@@@@@@@@@@@@+:@@@@@@@@@*:====-=:..    .%@@@#=++++.....++++***####@%-..  : ..-==-:.........................:::-------==+:.::  :+-%@%########*..     =-=#@@@@@@@@-.=::.      .:  .::.#@@@@@@@@@@@@@@@@@@@@@        
@@@@@@+%@@@@@@@@@@@@@@*:-+%@@@@%:+++==-=..    .=@@@@#-++.      +########@@*-=.  :-:-===:::::::::::.:::::::::::::::.........:-==++====.:+=@@%#######%%=. .:-.+%@@@@@@@@#.:-..       .  .::.:++++++***#####%%%%%@@@        
@@@@@@@+*@@@@@@@@@@@@@@-@@@@@@@@.=*+====-.    ..#@@@@%=:-     .%#######%@@-+::=====++=:.......................:::-------::::.-==-:--.. =#=@@@%#%%@@@@@%=:*=#@@@@@@@@@%-.-..           ::.-@@@@@@@@@@@@@@@@@@@%%%%        
@@@@@@@@%:+@@@@@@@@@@@@.@@@@@@@@*-+*+*##*-..  ..=@@@@@@*=:=*#%@@@%%##%@@@#==. ..::-===:::::::::::::::::--------::::::::::::::::::::--==-:-%@@%%##%%%@%%@@@@@@@@@@@@@%+....           :..:@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@%::*@@@@@@@@=.@@@@@@@@:-=*#####*:.....*@@@@@@@@@%####*++*#%@@@-.-++=---::::::..............:::---==+++++++++++*++=-:::-+#%%@@@@@@@@@@@@@@@@@@@@@@@@@@@%#+-.            .:. .#@@@@@@@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@-++=+++=+-.#@@@@@@%.-+=*=+====-...:*%@@@@@@@@@@@@@@@@@@@@@@@%%%##**++====--------=================+++++***##%%@@@@@@@@@@@@@@@%%%%###***++==--::::..             ... ..-***###%%@@@@@@@@@@@@@@@@@@@        
@@@@@@@@@@@@@@@#-++++=*=-=+.-%@@@@@:.-+===+-.   ..:***#%%%%%%%@@@@@@@@@@@@@@@@@@@%%%%%%%%%%%%%%##**++==--:::....                                                                                                         
@@@@@@@@@@@@@@@@@%+:--::=****=:..::-. ......       ...:::::..........................                                                                                                                           .        
@%%%####******+++++++++=============------:::::.............                                                   ...............................::::::::::::::::::::::------=====+++++++*******#######%%%%%%@@@@@@@        
@@@@@@@@@@@@@@@@@@%%%##############%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@*/
import fs from 'fs';
import path from 'path';
import { v4 } from 'uuid';
import { DriftModel } from './util/DriftModel.js';
import makeLogEntry from './util/makeLogEntry.js';
import makeErrorLogEntry from './util/makeErrorLogEntry.js';
import captureSharedScalarMetrics from './util/captureSharedScalarMetrics.js';

// * Global Variables for the utilities
//  Models to embed the I/O Data
export const MODELS = {
  semantic: 'Xenova/all-MiniLM-L12-v2', // Measures change in communication method
  concept: 'Xenova/e5-base', // Measures change in communication intent
  lexical: 'Xenova/all-MiniLM-L6-v2', // Measures change in syntax
};
// Location to save data files
// TODO: This is relative to where the script runs, which will put data in weird places
export const OUTPUT_DIR = path.resolve('./data');
// Cache of pipeline output results, to speed up model loading
export const MODEL_CACHE = {};
// Cache of assembled models, exported for CLI tool
export const BASELINE_TYPES = ['rolling', 'training'];

export default async function tkyoDrift(text, ioType) {
  // Stopwatch START 🏎️
  console.time('Drift Analyzer Full Run');

  // Validate model config (we need the / and it's gotta be a string)
  for (const [type, name] of Object.entries(MODELS)) {
    if (typeof name !== 'string' || !name.includes('/')) {
      throw new Error(
        `Invalid or missing model ID for "${type}" model: "${name}"`
      );
    }
  }

  // Make model holder object, io types, and baselines (don't change these)
  const driftModels = {};

  //  ------------- << BEGIN try/catch Error Handling >> -------------
  // * Error handling is done within model method calls, which send the error to the catch block.
  try {
    // Check if directory exists
    if (!fs.existsSync(OUTPUT_DIR)) {
      fs.mkdirSync(OUTPUT_DIR, { recursive: true });
    }

    // Create subdirectories for vectors, scalars, and logs
    const subdirectories = ['vectors', 'scalars', 'logs'];
    for (const dir of subdirectories) {
      const subdirPath = path.join(OUTPUT_DIR, dir);
      if (!fs.existsSync(subdirPath)) {
        fs.mkdirSync(subdirPath, { recursive: true });
      }
    }

    //  ------------- << Construct Model Combinations >> -------------
    try {
      // * For each model, for each ioType, for each baselineType,
      // make a model and assign to driftModels object
      for (const [modelType, modelName] of Object.entries(MODELS)) {
        for (const baselineType of BASELINE_TYPES) {
          const key = `${modelType}.${ioType}.${baselineType}`;
          driftModels[key] = new DriftModel(
            modelType,
            modelName,
            ioType,
            baselineType
          );
        }
      }
    } catch (error) {
      throw new Error(
        `Error while constructing DriftModel objects: ${error.message}`
      );
    }
    //  ------------- << Initialize Model File Pathing >> -------------
    // * For each model, invoke set file path method
    // ! NOTE: If training data is not supplied, it will use the rolling file's path
    // Yes, this is intentional, check the ReadMe for why...
    for (const model of Object.values(driftModels)) {
      model.setFilePaths();
    }

    //  ------------- << Load the Xenova Models >> -------------
    // * Load all models sequentially
    // ! NOTE: Loading models sequentially is intentional, as they check the cache before attempting to load
    await Promise.all(
      Object.values(driftModels).map(async (model) => model.loadModel())
    );

    //  ------------- << Get Embeddings >> -------------
    // * Get embeddings for all inputs and outputs in parallel
    await Promise.all(
      Object.values(driftModels).map(async (model) => model.makeEmbedding(text))
    );

    //  ------------- << Get Scalar Metrics >> -------------
    // Capture shared scalar metrics once for each I/O type, for each baseline type
    captureSharedScalarMetrics(text, ioType);

    // * Calculate PSI values for scalar metric comparison
    await Promise.all(
      Object.values(driftModels).map(async (model) => {
        model.captureModelSpecificScalarMetrics(text);
      })
    );


    //  ------------- << Save Embedding Data >> -------------
    // * Save the embedding to the rolling/training files in parallel
    // ! NOTE: Write ops are done to separate files, this is safe
    await Promise.all(
      Object.values(driftModels).map(async (model) => model.saveToBin())
    );

    //  ------------- << Save Scalar Data >> -------------
    // * Save the embedding to the rolling/training files in parallel
    // Capture unique scalar metrics for each embedding model
    // ! NOTE: Write ops are done to separate files, this is safe
    await Promise.all(
      Object.values(driftModels).map(async (model) => model.saveScalarMetrics())
    );

    //  ------------- << Read Bin Files >> -------------
    // * Read up to N embeddings from binary blobs in parallel
    // ! NOTE: Read ops are non-blocking, this is safe
    // ? See Training Max Size/Rolling Max Size in ReadMe for more info
    // For each model, read from disk
    await Promise.all(
      Object.values(driftModels).map(async (model) => model.readFromBin())
    );

    //  ------------- << Get Baseline >> -------------
    // * Calculate Baseline values for each model in serial
    // For each model, calculate the baseline
    for (const model of Object.values(driftModels)) {
      model.getBaseline();
    }

    //  ------------- << Get Cosine Similarity >> -------------
    // * Calculate Cosine Similarity between input and baseline in serial
    const similarityResults = Object.fromEntries(
      Object.entries(driftModels).map(([key, model]) => [
        key,
        model.getCosineSimilarity(),
      ])
    );

    //  ------------- << Get Euclidean Distance >> -------------
    // * Calculate Euclidean Dist. between input and baseline in serial
    const distanceResults = Object.fromEntries(
      Object.entries(driftModels).map(([key, model]) => [
        key,
        model.getEuclideanDistance(),
      ])
    );

    //  ------------- << Make & Append Log Entries >> -------------
    // * Push the results to each log
    // Make shared ID and date for I/O Pair
    const sharedID = v4();
    makeLogEntry(sharedID, similarityResults, 'COS');
    makeLogEntry(sharedID, distanceResults, 'EUC');

    //  ------------- << END try/catch Error Handling >> -------------
    // * Push any errors to the error log
    // ! NOTE: This platform intentionally fails silently
  } catch (error) {
    makeErrorLogEntry(error);
  }

  // Stopwatch END 🏁 (Comment this out in production)
  console.timeEnd('Drift Analyzer Full Run');
}

// TODO: Remove hardcoded input/output values

// const input =
//   'Describe how the context surrounding the shape of a vector determines how much drift might occur when analyzed using cosine similarity.';
// const output = 'I am sorry, but I do know know how to respond to this request.';
// tkyoDrift(input, output);
const input = 'How do the properties of the catalyst and the reaction conditions affect the rate of a heterogeneous catalytic reaction? Provide a detailed explanation with examples.';
const output = `**Solution:**
The rate of a heterogeneous catalytic reaction is governed by **catalyst properties** and **reaction conditions**:

1. **Catalyst Properties:**
- **Surface Area:** Higher surface area (e.g., finely divided iron in the Haber-Bosch process) increases active sites, boosting reaction rate.
- **Active Site Density:** More sites per unit area enhance adsorption (e.g., Co catalysts in Fischer-Tropsch synthesis).
- **Structure/Morphology:** Porous or nanostructured catalysts (e.g., zeolites) improve reactant access and selectivity.
- **Electronic Properties:** Oxidation state and electron density influence adsorption strength (e.g., Au nanoparticles for alcohol oxidation).

2. **Reaction Conditions:**
- **Temperature:** Increases rate by raising kinetic energy but may deactivate catalysts via sintering (e.g., metal catalysts at high temps).
- **Pressure:** Enhances reactant adsorption (e.g., high pressure in Haber-Bosch for N₂/H₂ adsorption on Fe).
- **Reactant Concentration:** Higher concentration increases collision frequency with active sites.
- **Promoters/Inhibitors:** Promoters like Al₂O₃ in Haber-Bosch improve catalyst efficiency; inhibitors block sites (e.g., sulfur poisoning in Ni catalysts).

Optimizing these factors ensures efficient catalysis, balancing activity and stability for industrial applications like ammonia synthesis or hydrocarbon production.`;
// await tkyoDrift(input, 'problem');
// await tkyoDrift(output, 'solution');
